{% extends "managementapp/kitchen.html" %}
{% load static %}

{% block title %}
<title>Restaurant Dashboard</title>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'style_reporting.css' %}">
<link rel="stylesheet" href="{% static 'style_kitchen.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="reporting-container">
    <!-- Error message container -->
    <div id="dashboard-error" class="error-message" style="display: none;"></div>
    
    <header class="reporting-header">
        <h1>Reporting and Analytics</h1>
        <select id="dateRangeSelect" class="date-range">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
        </select>
    </header>

    <main class="reporting-main">
        {% csrf_token %}
        
        <section class="summary-cards">
            <div class="summary-card">
                <h3>Total Orders</h3>
                <p id="totalOrders" class="summary-value">0</p>
            </div>
            <div class="summary-card">
                <h3>Total Revenue</h3>
                <p id="totalRevenue" class="summary-value">à¸¿0.00</p>
            </div>
            <div class="summary-card">
                <h3>Avg. Preparation Time</h3>
                <p id="preparationTime" class="summary-value">00:00:00</p>
            </div>
            
        </section>
        
        <!-- Charts -->
        <section class="charts-container">
            <div class="chart-box">
                <h2>Revenue Trend</h2>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-box">
                <h2>Item Performance</h2>
                <canvas id="itemPerformanceChart"></canvas>
            </div>
            <div class="chart-box" id="peak-hours">
                <h2>Peak hours</h2>
                <canvas id="busiestHoursChart"></canvas>
            </div>
        </section>

        <section class="top-selling">
            <h2>Top Selling Items</h2>
            <ul id="topSellingList" class="item-list"></ul>
        </section>

        <section class="top-selling">
            <h2>Least Selling Items</h2>
            <ul id="leastSellingItem" class="item-list"></ul>
        </section>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'reporting.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const dateRangeSelect = document.getElementById("dateRangeSelect");
    const revenueChartCtx = document.getElementById("revenueChart").getContext("2d");
    const itemPerformanceChartCtx = document.getElementById("itemPerformanceChart").getContext("2d");
    const busiestHoursChartCtx = document.getElementById("busiestHoursChart").getContext("2d");

    let revenueChart, itemPerformanceChart, busiestHoursChart;

    const sampleData = [
        { hour: '08:00', orders: 5 },
        { hour: '09:00', orders: 15 },
        { hour: '10:00', orders: 20 },
        { hour: '11:00', orders: 10 },
        { hour: '12:00', orders: 25 },
        { hour: '13:00', orders: 30 },
        { hour: '14:00', orders: 18 },
        { hour: '15:00', orders: 22 },
        { hour: '16:00', orders: 19 },
        { hour: '17:00', orders: 23 }
    ];

    // Function to create the peak hours chart
    function createBusiestHoursChart(data) {
        const hours = data.map(item => item.hour);
        const orders = data.map(item => item.orders);

        if (busiestHoursChart) busiestHoursChart.destroy();

        busiestHoursChart = new Chart(busiestHoursChartCtx, {
            type: 'bar',
            data: {
                labels: hours,
                datasets: [{
                    label: 'Orders',
                    data: orders,
                    backgroundColor: '#FF6384',
                    borderColor: '#FF6384',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: { display: true },
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 5 }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });
    }

    // Initialize with sample data
    createBusiestHoursChart(sampleData);

    // Function to update least selling item
    function updateLeastSellingItem(item) {
        const leastSellingItemElement = document.getElementById("leastSellingItem");
        leastSellingItemElement.textContent = `${item.name} (${item.quantity} sold)`;
    }

    // Fetch and update other data
    function fetchDashboardData(period = "today") {
        fetch(`/dashboard?period=${period}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            updateSummaryCards(data.dashboardData);
            updateRevenueChart(data.dashboardData.revenueData);
            updateTopSellingItems(data.topSellingItems);
            updateLeastSellingItem(data.leastSellingItem); // Update least-selling item
        })
        .catch(error => console.error("Error fetching dashboard data:", error));
    }

    dateRangeSelect.addEventListener("change", function() {
        fetchDashboardData(this.value);
    });

    fetchDashboardData();
});
</script>
{% endblock %}
